<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="recipe">
	<select id="getMaxCount" resultType="int">
		select max(rec_num) from recipe
	</select>
	<!-- 추가 -->
	<insert id="insertOfRecipe" parameterType="recipe_dto">
		insert into recipe values (0,#{portion},#{time},#{difficult},#{repre_photo},#{comp_photo},#{food_cate},
		#{subject},#{summary},0,now(),#{email},#{tip})
	</insert>
	<insert id="insertOfingre" parameterType="ingre_dto">
		insert into ingredient values (#{rec_num},#{ingre_name},#{quantity},#{sort})
	</insert>
	<insert id="insertOfOrder" parameterType="recipe_order_dto">
		insert into recipe_order values (#{rec_num},#{order_num},#{content},#{photo})
	</insert>

	<!-- 리스트 출력 -->
	<select id="getRecipe" parameterType="HashMap" resultType="recipe_dto">
		select r.*,c.nickname,c.profile from recipe r left join chef c on r.email=c.email 
		<if test="search!=''and search!=null">
			where subject like CONCAT('%',#{search},'%')
		</if>
		<if test="food_cate!=''and food_cate!=null">
			where food_cate = #{food_cate}
		</if>
		order by writeday desc limit #{start},#{end}
	</select>
	<!-- 재료를 검색해서 rec_num 구하기 -->
	<select id="getRec_nums" parameterType="HashMap" resultType="int">
		<![CDATA[
			select rec_num from (select * from ingredient where
		]]>
		<foreach collection="ingreList" item="list" index="index" separator="or">
			ingre_name like CONCAT('%',#{list},'%')
		</foreach>
		<![CDATA[
			) a
			group by rec_num having count(rec_num)>#{count}
			order by rec_num desc limit #{start},#{end}
		]]>
	</select>
	<!-- rec_num으로 recipe가져오기 -->
	<select id="getIngreRecipe" parameterType="int" resultType="recipe_dto">
		select r.*,c.nickname,c.profile from recipe r left join chef c on (r.email=c.email) where r.rec_num=#{rec_num}
	</select>
	
	<!-- total카운트 구하기-->
	<select id="getTotalCount" resultType="int">
		select count(*) from recipe
	</select>
	<!-- 선택 레시피 출력 -->
	<select id="getSelectOfRecipe" parameterType="int" resultType="recipe_dto">
		select r.*,c.nickname,c.profile from recipe r left join chef c on (r.email=c.email) where rec_num=#{rec_num}
	</select>
	<!-- 선택 레시피의 재료 -->
	<select id="getIngre" parameterType="int" resultType="ingre_dto">
		select * from ingredient where rec_num=#{rec_num}
	</select>
	<!-- 선택 레시피 조리순서 및 사진 -->
	<select id="getOrder" parameterType="int" resultType="recipe_order_dto">
		select * from recipe_order where rec_num=#{rec_num} order by order_num
	</select>
	
	<!-- 삭제 -->
	<delete id="deleteOrder" parameterType="int">
		delete from recip_order where rec_num=#{rec_num}
	</delete>
	<delete id="deleteIngredient" parameterType="int">
		delete from ingredient where rec_num=#{rec_num}
	</delete>
	<delete id="deleteRecipe" parameterType="int">
		delete from recipe where rec_num=#{rec_num}
	</delete>
	
	<!-- readcount 증가 -->
	<update id="updateReadcount" parameterType="int">
		update recipe set readcount=readcount+1 where rec_num=#{rec_num}
	</update>
	<select id="getCountOfread" parameterType="int" resultType="int">
		select readcount from recipe where rec_num=#{rec_num}
	</select>
	
	<!-- 업데이트 -->
	
</mapper>